<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>여러 주소를 한 지도에 표시하기 (카카오 지도, 모바일 최적화)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        "Noto Sans KR", Arial, sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* 상단 바 */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      background: #2e7d32; /* 카카오랑 상관 없이 초록톤 */
      color: #fff;
    }

    header h1 {
      font-size: 16px;
      margin: 0;
    }

    #toggle-panel-btn {
      border: none;
      background: rgba(255, 255, 255, 0.15);
      color: #fff;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }

    #toggle-panel-btn:active {
      transform: scale(0.97);
    }

    /* 메인 레이아웃 */
    #main {
      flex: 1;
      display: flex;
      min-height: 0;
    }

    #control-panel {
      width: 360px;
      max-width: 100%;
      padding: 12px;
      border-right: 1px solid #e0e0e0;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: #fafafa;
      overflow-y: auto;
    }

    #control-panel h2 {
      font-size: 14px;
      margin: 0 0 4px 0;
    }

    label span.label-title {
      display: inline-block;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    textarea {
      width: 100%;
      height: 180px;
      resize: vertical;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 13px;
    }

    input[type="file"] {
      width: 100%;
      margin-top: 4px;
    }

    small {
      font-size: 11px;
      color: #777;
      display: block;
      margin-top: 4px;
      line-height: 1.4;
    }

    .button-row {
      display: flex;
      gap: 8px;
    }

    button {
      padding: 10px 12px;
      border-radius: 6px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      flex: 1;
    }

    #plot-btn {
      background: #2e7d32;
      color: white;
      font-weight: 600;
    }

    #clear-btn {
      background: #e0e0e0;
      color: #333;
    }

    #status {
      font-size: 12px;
      color: #555;
      white-space: pre-line;
      min-height: 70px;
      max-height: 120px;
      overflow-y: auto;
      border-radius: 6px;
      border: 1px solid #eee;
      padding: 8px;
      background: #fff;
    }

    #map {
      flex: 1;
      min-height: 260px;
    }

    /* 모바일 레이아웃 */
    @media (max-width: 768px) {
      #main {
        flex-direction: column;
      }

      #control-panel {
        width: 100%;
        max-height: 55%;
        border-right: none;
        border-bottom: 1px solid #e0e0e0;
      }

      #map {
        flex: 1;
      }
    }

    /* 패널 숨김 */
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <header>
    <h1>주소 여러 개 카카오 지도에 표시</h1>
    <button id="toggle-panel-btn">설정 접기</button>
  </header>

  <div id="main">
    <div id="control-panel">
      <section>
        <h2>1. 주소 입력</h2>
        <label>
          <span class="label-title">주소 목록 (한 줄에 한 개씩)</span>
          <textarea
            id="address-input"
            placeholder="예)
서울특별시 중구 세종대로 110
서울특별시 송파구 올림픽로 300"
          ></textarea>
        </label>
      </section>

      <section>
        <h2>2. 파일에서 불러오기</h2>
        <span class="label-title">주소 파일 업로드 (.txt / .csv)</span>
        <input type="file" id="file-input" accept=".txt,.csv" />
        <small>
          • TXT: 한 줄에 한 주소<br />
          • CSV: 각 줄의 <b>마지막 칸</b>을 주소로 사용합니다.<br />
          예: 이름,메모,주소
        </small>
      </section>

      <section>
        <h2>3. 실행</h2>
        <div class="button-row">
          <button id="plot-btn">지도에 표시</button>
          <button id="clear-btn">초기화</button>
        </div>
      </section>

      <section>
        <h2>상태</h2>
        <div id="status">상태 메시지가 여기에 표시됩니다.</div>
      </section>
    </div>

    <div id="map"></div>
  </div>

  <!-- ✅ 카카오 지도 JS API (본인 자바스크립트 키로 교체) -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=c40d8efd4823e232fe4727336483ecef=services"></script>

  <script>
    let map;
    let geocoder;
    let markers = [];
    let bounds;

    function initKakaoMap() {
      const container = document.getElementById("map");
      const options = {
        center: new kakao.maps.LatLng(37.5665, 126.9780), // 서울 시청 근처
        level: 5
      };
      map = new kakao.maps.Map(container, options);

      // 주소-좌표 변환 객체
      geocoder = new kakao.maps.services.Geocoder();

      // bounds (LatLngBounds 비슷한 기능을 직접 구현)
      bounds = new kakao.maps.LatLngBounds();

      document.getElementById("plot-btn").addEventListener("click", handlePlot);
      document.getElementById("clear-btn").addEventListener("click", clearAll);
      document
        .getElementById("file-input")
        .addEventListener("change", handleFileUpload);

      // 패널 접기/펼치기
      const toggleBtn = document.getElementById("toggle-panel-btn");
      const panel = document.getElementById("control-panel");

      toggleBtn.addEventListener("click", () => {
        const isHidden = panel.classList.toggle("hidden");
        toggleBtn.textContent = isHidden ? "설정 펼치기" : "설정 접기";

        // 레이아웃 변경 후 지도 리사이즈
        setTimeout(() => {
          map.relayout();
        }, 200);
      });
    }

    // 카카오 스크립트 로딩 후 init
    if (document.readyState === "complete") {
      kakao.maps.load(initKakaoMap);
    } else {
      document.addEventListener("DOMContentLoaded", () => {
        kakao.maps.load(initKakaoMap);
      });
    }

    function setStatus(msg) {
      const statusEl = document.getElementById("status");
      statusEl.textContent = msg;
      statusEl.scrollTop = statusEl.scrollHeight;
    }

    function appendStatus(msg) {
      const statusEl = document.getElementById("status");
      statusEl.textContent += "\n" + msg;
      statusEl.scrollTop = statusEl.scrollHeight;
    }

    function clearAll() {
      markers.forEach((m) => m.setMap(null));
      markers = [];
      bounds = new kakao.maps.LatLngBounds();
      setStatus("초기화 완료");
    }

    function handlePlot() {
      clearAll();

      const rawText = document.getElementById("address-input").value.trim();

      if (!rawText) {
        setStatus("주소가 없습니다. 주소를 입력하거나 파일을 업로드하세요.");
        return;
      }

      const lines = rawText
        .split(/\r?\n/)
        .map((l) => l.trim())
        .filter((l) => l.length > 0);

      if (lines.length === 0) {
        setStatus("유효한 주소가 없습니다.");
        return;
      }

      setStatus(`총 ${lines.length}개의 주소를 지도에 표시합니다...`);

      geocodeAddressesSequential(lines, 0);
    }

    function geocodeAddressesSequential(addresses, index) {
      if (index >= addresses.length) {
        // 모든 주소 처리 후, bounds가 비어있지 않으면 지도 범위 조정
        if (!bounds.isEmpty && markers.length > 0) {
          map.setBounds(bounds);
        }
        appendStatus("모든 주소 처리 완료.");
        return;
      }

      const address = addresses[index];
      appendStatus(`[${index + 1}/${addresses.length}] 지오코딩 중: ${address}`);

      // 카카오 주소검색 (도로명/지번 모두 처리)
      geocoder.addressSearch(address, (result, status) => {
        if (status === kakao.maps.services.Status.OK && result.length > 0) {
          const first = result[0];
          const coords = new kakao.maps.LatLng(first.y, first.x);

          // 마커 생성 (번호 라벨은 title로 표시, 인포윈도우로 자세한 정보)
          const marker = new kakao.maps.Marker({
            map: map,
            position: coords
          });

          const iwContent =
            '<div style="font-size:13px; padding:4px 6px; max-width:220px;">' +
            `<b>#${index + 1}</b><br/>` +
            `입력한 주소: ${address}<br/>` +
            `검색 결과: ${first.address_name || ""}` +
            "</div>";

          const infowindow = new kakao.maps.InfoWindow({
            content: iwContent
          });

          kakao.maps.event.addListener(marker, "click", () => {
            infowindow.open(map, marker);
          });

          markers.push(marker);
          bounds.extend(coords);
        } else {
          appendStatus(`→ 실패: "${address}" (${status})`);
        }

        setTimeout(() => {
          geocodeAddressesSequential(addresses, index + 1);
        }, 200);
      });
    }

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        const text = e.target.result;
        const isCsv = file.name.toLowerCase().endsWith(".csv");
        const addresses = parseTextToAddresses(text, isCsv);

        if (addresses.length === 0) {
          setStatus("파일에서 주소를 찾지 못했습니다.");
          return;
        }

        const textarea = document.getElementById("address-input");
        textarea.value = addresses.join("\n");

        setStatus(
          `파일에서 ${addresses.length}개의 주소를 읽었습니다. "지도에 표시" 버튼을 눌러주세요.`
        );
      };

      reader.readAsText(file, "utf-8");
    }

    function parseTextToAddresses(text, isCsv) {
      const lines = text.split(/\r?\n/).map((l) => l.trim());
      const addresses = [];

      for (let line of lines) {
        if (!line) continue;

        if (isCsv) {
          const parts = line.split(",");
          const addr = parts[parts.length - 1].trim();
          if (addr) addresses.push(addr);
        } else {
          addresses.push(line);
        }
      }

      return addresses;
    }
  </script>
</body>
</html>
